---
title: "Egg CVD study (stroke/TIA as outcome)"
output: github_document
always_allow_html: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Required packages
pacs <- c("tidyverse", "readxl", "lubridate", "tableone", "gridExtra", "survival")
sapply(pacs, require, character.only = TRUE)

# Function to search variables
search_var <- function(df, pattern, ...) {
  loc <- grep(pattern, names(df), ...)
  if (length(loc) == 0) warning("There are no such variables")
  else return(data.frame(loc = loc, varname = names(df)[loc]))
}

# Medicare crosswalk ------------------------------------------------------

# Read crosswalk file: n = 70.968
crosswalk <- read_fwf("./Data/12172/2022/ssn_bene_xwalk_res000058038_req012172_2022.dat",
                      fwf_widths(c(9, 15, 1, 1, 1), c("ORIG_SSN", "BENE_ID", "SSN_MATCH", "SEX_MATCH", "DOB_MATCH")))

# Extract matched BENE_IDs
all_matched_bene_ids <- crosswalk %>% 
  filter(SSN_MATCH == 1)

# BENE_IDs of gender or DOB mismatch (to be removed)
mismatches <- crosswalk %>% 
  filter(SSN_MATCH == 1 & (SEX_MATCH == 0 | DOB_MATCH == 0)) %>%
  select(BENE_ID)
  
# There are two duplicates in BENE_IDs...
dup_BENE_IDs <- all_matched_bene_ids %>% 
  group_by(BENE_ID) %>% 
  summarize(n = sum(n())) %>% 
  filter(n > 1)

# There are 106 SSN duplicates 
dup_SSNs <- all_matched_bene_ids %>% 
  group_by(ORIG_SSN) %>% 
  summarize(n = sum(n())) %>% 
  filter(n > 1)

# BENE_IDs that need to be removed:
# Gender/DOB mismatch
# SSN/BENE_ID duplicates
exclude_BENE_IDs <- dup_BENE_IDs %>% 
  select(BENE_ID) %>% 
  union(all_matched_bene_ids %>% 
          filter(ORIG_SSN %in% dup_SSNs$ORIG_SSN) %>% 
          select(BENE_ID)
  ) %>% 
  union(mismatches)

# Medicare MSBF file ------------------------------------------------------

# Read MBSF Summary data on each year
# Data specification of MSBF files
fts_msbf <- read_excel("./Data/mbsf_format.xlsx")

# Create file names: 2008-2020
year <- 2008:2020
fname <- paste0("./Data/12172/", year, "/mbsf_abcd_summary_res000058038_req012172_", year, ".dat")

# Read all MSBF files of 13 years
all_msbf <- fname %>% 
  lapply(\(x) read_fwf(x, fwf_widths(fts_msbf$length, fts_msbf$long_name))) %>% 
  lapply(\(x) anti_join(x, exclude_BENE_IDs)) %>% 
  setNames(year)

# Read MSBF files of additional 2 years: 2021-2022
year <- 2021:2022
fname <- paste0("./Data/14345/", year, "/mbsf_abcd_summary_res000058038_req014345_", year, ".dat")

add_msbf <- fname %>% 
  lapply(\(x) read_fwf(x, fwf_widths(fts_msbf$length, fts_msbf$long_name))) %>% 
  lapply(\(x) anti_join(x, exclude_BENE_IDs)) %>% 
  setNames(year)

# Append
all_msbf2 <- c(all_msbf, add_msbf)

# Long format over years
all_msbf_long <- all_msbf2 %>% 
  do.call(rbind, .) %>% 
  arrange(BENE_ID, BENE_ENROLLMT_REF_YR)

# Medicare chronic condition file -----------------------------------------

# Read chronic conditions data on each year
fts_cc <- read_excel("./Data/mbsf_cc_format.xlsx")

# Create file names
year <- 2008:2020
fname <- paste0("./Data/12172/", year, "/mbsf_cc_summary_res000058038_req012172_", year, ".dat")

# Read all MSBF files of 13 years
all_cc <- fname %>% 
  lapply(\(x) read_fwf(x, fwf_widths(fts_cc$length, fts_cc$long_name))) %>% 
  lapply(\(x) anti_join(x, exclude_BENE_IDs)) %>% 
  setNames(year)

# Data specification of Chronic files
fts_chronic <- read_excel("./Data/mbsf_chronic_format.xlsx")

# Read MSBF files of additional 2 years: 2021-2022
year <- 2021:2022
fname <- paste0("./Data/14345/", year, "/mbsf_chronic_summary_res000058038_req014345_", year, ".dat")

# Some CC variables must be renamed
# Chronic conditions; name changes
  # Hyperlipidemia: HYPERL_EVER to HLP_EVER
  # CHF: CHF_EVER to HF_EVER
  # Hypertension: HYPERT_EVER to HTN_EVER
  # Hypothyroid: HYPOTH_EVER to HYPTHYRD_EVER

add_cc <- fname %>% 
  lapply(\(x) read_fwf(x, fwf_widths(fts_chronic$length, fts_chronic$long_name))) %>% 
  lapply(\(x) anti_join(x, exclude_BENE_IDs)) %>%
  lapply(\(x) rename(x, HYPERL_EVER = HLP_EVER, CHF_EVER = HF_EVER, HYPERT_EVER = HTN_EVER, HYPOTH_EVER = HYPTHYRD_EVER)) %>% 
  setNames(year)

# Append
all_cc2 <- c(all_cc, add_cc)

# Long format over years
all_cc_long <- all_cc2 %>%
  do.call(bind_rows, .) %>% 
  arrange(BENE_ID, BENE_ENROLLMT_REF_YR)

# AHS-2 Medicare link file ------------------------------------------------

# AHS-2 analysis ID: N = 51,917
ahs <- read_csv("./Data/MedicareMatches2022.csv")

# There are 103 analysis IDs that appears twice
# There are 226 NULL values on analysis ID
# 104 analysis IDs (103 duplicates + NAs) to be removed
exclude_analysisIDs <- ahs %>% 
  group_by(AnalysisID) %>%
  tally() %>% 
  filter(n > 1) %>%
  select(AnalysisID)

# 432 rows removed (103 * 2 + 226)
# yielding 51,485 unique analysis ID (and unique Bene_IDs)
ahs_dup_removed <- ahs %>% anti_join(exclude_analysisIDs)

# AHS-2 data --------------------------------------------------------------

# # N = 96,144
ahsdata <- read.csv("./Data/BaselineDataForMedicare20190531.csv", header=TRUE)
names(ahsdata) <- tolower(names(ahsdata))

# File names of 5 imputed data
imputed_file_names <- dir("./Data", full.names = TRUE) %>% grep("04-24.csv", ., value = TRUE)

# Read into a list of data frames
imputed_data <- imputed_file_names %>% lapply(read_csv)

# N = 41,037
ahsdata2 <- imputed_data[[1]] %>%
  rename(agein = calc_baseline_age) %>% 
  
  # Get qreturndate from ahsdata and convert to date
  inner_join(ahsdata %>% select(analysisid, qreturndate), by = "analysisid") %>% 
  mutate(qreturndate = as.Date(qreturndate),
         
  # Demographic/lifestyle variables
         bmicat    = cut(bmi, breaks = c(0, 25, 30, Inf), right = FALSE),
         bmicat    = factor(bmicat, labels = c("Normal", "Overweight", "Obese")),
         marital   = recode(marital, "Never", "Married", "Married", "Married", "Div/Wid", "Div/Wid", "Div/Wid"),
         marital   = factor(marital, levels = c("Married", "Never", "Div/Wid")),
         # educyou   = factor(educat3, levels = c("HSch & below", "Some College", "Bachelors +")),
         educyou   = factor(educat3, labels = c("Bachelors +","HSch & below", "Some College")),
         educyou   = fct_relevel(educyou, "HSch & below", "Some College", "Bachelors +"),
         educyou2  = relevel(educyou, ref = "Bachelors +"),
         sleephrs  = recode(sleephrs - 2, "<= 5 hrs", "<= 5 hrs", "<= 5 hrs", "6 hrs", "7 hrs",  
                                      "8 hrs", ">= 9 hrs", ">= 9 hrs", ">= 9 hrs"),
         sleephrs  = factor(sleephrs, levels = c("<= 5 hrs", "6 hrs", "7 hrs", "8 hrs", ">= 9 hrs")),
         sleephrs2 = relevel(sleephrs, ref = "7 hrs"),
         vegstat   = 1 * vegan + 2 * lacto + 3 * semi + 4 * pesco + 5 * nonveg,
         vegstat   = factor(vegstat, labels=c("Vegan", "Lacto-ovo",  "Semi", "Pesco", "Non-veg")),
         vegstat2  = relevel(vegstat, ref = "Non-veg"),
         exercise  = cut(exermin_week, breaks = c(-Inf, 0, 30, 120, Inf), right = TRUE),
         exercise  = factor(exercise, labels = c("None", "â‰¤0.5 hrs/wk", "0.5<-2 hrs/wk", ">2 hrs/wk")),
         # smokecat  = factor(smokecat6, labels = c("Never", rep("Ever", 5))),
         smokecat6 = factor(smokecat6),
         # alccat    = ifelse(wine2cat == "1no" & beerliq2 == "1no", "Never", "Ever"),
         alccat    = ifelse(winegd == 0 & beergd == 0 & liquorgd == 0, "Never", "Current"),
         alccat    = factor(alccat, levels = c("Never", "Current")), 
  
  # Dietary variables
         egg_freq  = recode(eggbetrf, 1, 2, 3, 4, 5, 5, 5, 5, 5),
         egg_freq  = factor(egg_freq, labels = c("Never", "1-3/mo", "1/wk", "2-4/wk", "5+/wk")),
         kcal      = kcaldiet + kcalsupp,
         meat_gramdiet = procredmeat_gramdiet + unprocredmeat_gramdiet + procpoultry_gramdiet + unprocpoultry_gramdiet,
         # fish_gramdiet = fattyfish_gramdiet + otherfish_gramdiet,
         grains_gramdiet = wholegrains_gramdiet + mixedgrains_gramdiet + refgrains_gramdiet,
         whole_mixed_grains_gramdiet = wholegrains_gramdiet + mixedgrains_gramdiet)

# Opt-outs: n = 395
# Already excluded?
optout <- read_csv("./Data/OptOutAnalysisIDs.csv") %>% setNames("analysisid")

# Those who live outside US
# None found in the AHS data above 

# Merge AHS data with Medicare --------------------------------------------

# Extract data of the last seen: MSBF and CC files  
msbf_last_seen <- all_msbf_long %>%
  group_by(BENE_ID) %>% 
  slice(n())

cc_last_seen <- all_cc_long %>%
  group_by(BENE_ID) %>% 
  slice(n())

# Merge AHS data with Medicare
# Results in n = 41,037 subjects
ahs_medic <- msbf_last_seen %>% 
  inner_join(cc_last_seen %>% select(-BENE_ENROLLMT_REF_YR), by = "BENE_ID") %>%
  inner_join(ahs_dup_removed %>% 
               rename(BENE_ID = Bene_ID) %>% 
               mutate(analysisid = parse_number(AnalysisID)), by = "BENE_ID") %>% 
  inner_join(ahsdata2, by = "analysisid") %>% 
  ungroup()

# Apply inclusion/exclusion criteria --------------------------------------

# Remove if AGE_AT_END_REF_YR < 65 (n = 1105)
# Results in n = 39,932
ahs_medic <- ahs_medic %>% 
  filter(AGE_AT_END_REF_YR >= 65)

# Remove if BMI is extreme (n = 82)
# Resuts in n = 39,850
ahs_medic <- ahs_medic %>% 
  filter(bmi >= 16, bmi <= 60)

# Need to exclude unverified deaths
# There are 23 unverified deaths
unverified_deaths <- ahs_medic %>% 
  filter(!is.na(BENE_DEATH_DT)) %>%
  filter(is.na(VALID_DEATH_DT_SW)) %>% 
  select(analysisid)

# Exclude unverified deaths
# Yields n = 39,827
ahs_medic <- ahs_medic %>% 
  anti_join(unverified_deaths, by = "analysisid") 

# Identify stroke cases
ahs_medic <- ahs_medic %>% 
  mutate(STRK_YN = ifelse(is.na(STROKE_TIA_EVER), 0, 1),
         STRK_YN = factor(STRK_YN, label = c("No", "Yes")))   

prev_cases <- ahs_medic %>% 
  filter(STRK_YN == "Yes") %>% 
  mutate(STROKE_TIA_EVER = ymd(STROKE_TIA_EVER)) %>%
  filter(STROKE_TIA_EVER <= qreturndate) %>% 
  select(BENE_ID, analysisid)

# Exclude prevalent cases
# Yields n = 39,157 subjects
ahs_medic <- ahs_medic %>% 
  anti_join(prev_cases, by = "analysisid") %>% 
  mutate(BENE_BIRTH_DT = ymd(BENE_BIRTH_DT),
         BENE_DEATH_DT = ymd(BENE_DEATH_DT),
         STROKE_TIA_EVER = ymd(STROKE_TIA_EVER))

```

## Aim

* Assess if the risk of developing CVD varies according to levels of meat intake among regular egg consumers with hyperlipidemia using the AHS-2 cohort linked with Medicare data

* Assess the interaction between race and egg intake on the incidence of CVD among those with hyperlipidemia. 

## Datasets

* Medicare data
  * For details regarding Medicare data, see [AHS-2 Medicare Linkage](https://github.com/keijioda/ahs_medicare_linkage/blob/main/summary.md) repository.
  
  * Master Beneficiary Summary File (MBSF), 2008-2022
    * Contains beneficiary characteristics and enrollment information
    
  * Chronic Conditions file (CC), 2008-2022
    * Contains the first occurrence date of 27 or 30 specific chronic conditions
      * 27 chronic conditions for data 2008-2020
      * 30 chronic conditions for data 2021-2022
    * Used to identify prevalent/incident cases of cardio-vascular diseases and
    * to identify comorbidities
    
  * Both files include n = 46,897 unique subjects across years, after excluding 
    * Gender/DOB mismatch with AHS-2 data
    * Dupulicate beneficiary IDs and SSNs

* For AHS-2 baseline data, including food-frequency questionnaire (FFQ), a guided multiple imputation was used to fill missing data ([Fraser & Yan, 2007](https://pubmed.ncbi.nlm.nih.gov/17259903/))
  * Five imputed data sets were generated for subsequent analyses (See the analysis section for more details)
  * For descriptive analysis, we present results from the first imputed data
  
* AHS-2 baseline imputed data #1: n = 41,037
  * ~~Among this, n = 383 subjects were excluded because they opted out of the study~~
  * ~~After removing opt-outs, there were n = 87,668 subjects~~
  * Opt-outs were already excluded
 
* After merging Medicare and AHS-2 data, there were n = 41,037 subjects.

## Inclusion/exclusion criteria

* Medicare beneficiaries who did not reach the age of 65 between 2008 and 2020 (e.g., younger beneficiaries with disabilities or end-stage renal disease) were excluded (n = 1105), resulting n = 39,932.

* Subjects with extreme BMI (<16 or >60), according to AHS questionnaire, were excluded (n = 82), resulting n = 39,850.

* Unverified dates of deaths
  * Medicare data include a variable (`VALID_DEATH_DT_SW`) indicating whether a beneficiary's day of death has been verified by the Social Security Administration or the Railroad Retirement Board.
  * There were 23 unverified death dates. Excluding these resulted n = 39,827.

* Prevalent cases of stroke/TIA
  * If the first diagnosis was made on or before AHS-2 enrollment date, consider it as a prevalent case
  * n = 670 prevalent cases were exluded, resulting n = 39,157 subjects

## Outcome

```{r setup_outcome, include = FALSE}

# Identify hyperlipidemia cases -------------------------------------------

# Identify those with hyperlipidemia
# Both prevalence and incidence
ahs_medic <- ahs_medic %>% 
  mutate(HYPERL_YN = ifelse(is.na(HYPERL_EVER), 0, 1),
         HYPERL_YN = factor(HYPERL_YN, label = c("No", "Yes")),  
         BENE_BIRTH_DT = ymd(BENE_BIRTH_DT),
         BENE_DEATH_DT = ymd(BENE_DEATH_DT),
         HYPERL_EVER = ymd(HYPERL_EVER))

# Define CVD cases --------------------------------------------------------

names(ahs_medic) %>% grep("_EVER", ., value = TRUE)
cvd_vars <- c("STROKE_TIA_EVER")

cvd_df <- ahs_medic %>% 
  select(all_of(cvd_vars)) %>% 
  mutate_all(ymd) %>% 
  mutate_all(\(x) ifelse(is.na(x), "No", "Yes"))

# Based on Stroke only
ahs_medic2 <- ahs_medic %>% 
  mutate(STROKE_TIA_EVER = ymd(STROKE_TIA_EVER), 
         STRK_YN = ifelse(is.na(STROKE_TIA_EVER), 0, 1),
         STRK_YN = factor(STRK_YN, labels = c("No", "Yes")))

# Define variables for models ---------------------------------------------

# Define ageout
# If CVD_EVER exists (incident cases), the use this diag date
# If non-case and BENE_DEATH_DT exists, then use this date died (censored)
# Otherwise, use the end of BENE_ENROLLMT_REF_YR (year last seen)
# Calculate age at hyperlipidemia
# If hyperlipidemia occurs after CVD event, set hyperl_age as missing
ahs_medic_inc <- ahs_medic2 %>% 
  mutate(
    age_last_seen = time_length(interval(BENE_BIRTH_DT, make_date(BENE_ENROLLMT_REF_YR, 12, 31)), "year"),
    ageout = case_when(
              STRK_YN == "Yes" ~ time_length(interval(BENE_BIRTH_DT, STROKE_TIA_EVER), "year"),
              STRK_YN == "No" & !is.na(BENE_DEATH_DT)  ~ time_length(interval(BENE_BIRTH_DT, BENE_DEATH_DT), "year"),
              STRK_YN == "No" &  is.na(BENE_DEATH_DT)  ~ age_last_seen),
    hyperl_age = case_when(
              HYPERL_YN == "Yes" ~ time_length(interval(BENE_BIRTH_DT, HYPERL_EVER), "year"),
              .default = NA
    ),
    hyperl_age = if_else(hyperl_age > ageout, NA, hyperl_age),
    fuyear = ageout - agein,
    bene_sex_F = factor(SEX_IDENT_CD, labels = c("M", "F")),
    bene_age_at_end_2020 = time_length(interval(BENE_BIRTH_DT, make_date(2020, 12, 31)), "year"),
    agecat     = cut(bene_age_at_end_2020, breaks = c(65, 70, 75, 80, 85, 90, 95, 130), right = FALSE),
    agecat     = factor(agecat, labels = c("65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95+")),
    rti_race3  = recode(RTI_RACE_CD + 1, 3, 1, 2, 3, 3, 3, 3),
    rti_race3  = factor(rti_race3, labels = c("NH White", "Black", "Other"))
  )
```

* The outcome is stroke/TIA
* Among n = 39,157 subjects, there were 6042 incident cases (15.4%) of stroke/TIA
* Age at diagnosis was calculated using ``STOKE_TIA_EVER`` variable in the Chronic Condition Warehouse (CCW) data. This variable shows the date when the beneficiary first met the criteria after January 1, 1999.
  * For 27 CCW chronic conditions algorithms, see [here](https://www2.ccwdata.org/documents/10280/19139421/ccw-chronic-condition-algorithms.pdf)
  * For 30 CCW chronic conditions algorithms, see [here](https://www2.ccwdata.org/web/guest/condition-categories-chronic)
* Among these incident stoke/TIA cases, the mean (SD) age of diagnosis was 80.8 (8.2) years. The median age of diagnosis was 81.1 years.

## Comorbidity

```{r setup_comorbidity, include = FALSE}

# Prevalent comorbidity according to CMS
dzvars <- c("cataract", "chronickidney", "copd", "diabetes", "glaucoma",
            "hip_fracture", "depression", "osteoporosis", "ra_oa",  
            "cancer_breast", "cancer_colorectal", "cancer_prostate", "cancer_lung", "cancer_endometrial",
            "asthma", "hyperl", "hypert", "hypoth", "anemia")
dzvars <- paste0(toupper(dzvars), "_EVER")

# Convert all comodidity ever variables to date
test <- ahs_medic_inc %>% 
  mutate(across(all_of(dzvars), ymd)) 

find_prevalence <- function(var, data, start){
  cc_var <- data[[var]]
  strtdt  <- data[[start]]
  out <- ifelse(cc_var <= strtdt, 1, 0)
  out <- ifelse(is.na(cc_var), 0, out)
  return(out)
}

dzdf <- as.data.frame(lapply(dzvars, find_prevalence, data = test, start = "qreturndate"))
names(dzdf) <- paste0(dzvars, "_YN")
dzdf <- as_tibble(dzdf)

dzdf <- dzdf %>% 
  mutate(como_depress  = DEPRESSION_EVER_YN,
         como_diabetes = DIABETES_EVER_YN,
         como_kidney   = CHRONICKIDNEY_EVER_YN,
         como_hypoth   = HYPOTH_EVER_YN,
         como_anemia   = ANEMIA_EVER_YN,
         como_hypert   = HYPERT_EVER_YN,
         como_hyperl   = HYPERL_EVER_YN,
         como_cancers  = ifelse(rowSums(.[grep("CANCER_", names(.))]) > 0, 1, 0),
         como_disab    = ifelse(rowSums(.[grep("CATARACT|GLAU|HIP|OSTEO|RA_OA", names(.))]) > 0, 1, 0),
         como_hthl     = ifelse(rowSums(.[grep("HYPERT|HYPERL",  names(.))]) > 0, 1, 0),
         como_resp     = ifelse(rowSums(.[grep("COPD|ASTHMA",  names(.))]) > 0, 1, 0)) %>% 
  mutate_at(vars(starts_with("como_")), factor, labels = c("No", "Yes")) %>% 
  select(starts_with("como_"))

ahs_medic_inc2 <- ahs_medic_inc %>% 
  bind_cols(dzdf)

```

## Dietary variables

```{r setup_dietary, include = FALSE}

# dietary variables -------------------------------------------------------

# Food group variables
# Energy-adjust with zero partition
# By default, variables are log-transformed (excluding zeros)
kcal_adjust <- function(data, var, energy, log=TRUE){
  if (missing(var))
    stop("Need to specify variable for energy-adjustment.")
  if (missing(energy))
    stop("Need to specify energy intake.")
  if (missing(data))
    stop("Need to specify a data frame.")
  df <- eval(substitute(data.frame(y = data$var, ea_y = data$var, kcal = data$energy)))
  count_negative <- sum(df$y < 0, na.rm=TRUE)
  if (count_negative > 0)
    warning("There are negative values in variable.")
  if(log) df$y[df$y > 0 & !is.na(df$y)] <- log(df$y[df$y > 0 & !is.na(df$y)])
  mod <- lm(y ~ kcal, data=df[df$y != 0, ])
  if(log){
    ea <- exp(resid(mod) + mean(df$y[df$y != 0], na.rm=TRUE))
    df$ea_y[!is.na(df$y) & df$y != 0] <- ea
  }
  else{
    ea <- resid(mod) + mean(df$y[df$y != 0], na.rm=TRUE)
    df$ea_y[!is.na(df$y) & df$y != 0] <- ea
  }
  return(df$ea_y)
}

ahs_medic_inc2$meat_gram_ea      <- kcal_adjust(meat_gramdiet,  kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$fish_gram_ea      <- kcal_adjust(fish_gramdiet,  kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$eggs_gram_ea      <- kcal_adjust(eggs_gramdiet,  kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$alldairy2_gram_ea <- kcal_adjust(alldairy2_gramdiet, kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$nutsseeds_gram_ea <- kcal_adjust(nutsseeds_gramdiet, kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$totalveg_gram_ea  <- kcal_adjust(totalveg_gramdiet, kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$fruits_gram_ea    <- kcal_adjust(fruits_gramdiet, kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$legumes_gram_ea   <- kcal_adjust(legumes_gramdiet, kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$refgrains_gram_ea    <- kcal_adjust(refgrains_gramdiet, kcal, data = ahs_medic_inc2, log = TRUE)
ahs_medic_inc2$whole_mixed_grains_gram_ea    <- kcal_adjust(whole_mixed_grains_gramdiet, kcal, data = ahs_medic_inc2, log = TRUE)

ahs_medic_inc2 <- ahs_medic_inc2 %>% 
  mutate(meat_gram_ea_4 = cut(meat_gram_ea, breaks = c(-Inf, 0, 11, 33, Inf), right = TRUE), 
         fish_gram_ea_4 = cut(fish_gram_ea, breaks = c(-Inf, 0,  9, 18, Inf), right = TRUE),
         alldairy2_gram_ea_4 = cut(alldairy2_gram_ea, breaks = c(-Inf, 0,  50, 180, Inf), right = TRUE),
         totalveg_gram_ea_4 = cut(totalveg_gram_ea, breaks = c(-Inf, 185, 270, 380, Inf), right = TRUE),
         fruits_gram_ea_4 = cut(fruits_gram_ea, breaks = c(-Inf, 170, 280, 420, Inf), right = TRUE),
         nutsseeds_gram_ea_4 = cut(nutsseeds_gram_ea, breaks = c(-Inf, 9, 18, 32, Inf), right = TRUE),
         legumes_gram_ea_4 = cut(legumes_gram_ea, breaks = c(-Inf, 33, 60, 100, Inf), right = TRUE),
         refgrains_gram_ea_4 = cut(refgrains_gram_ea, breaks = c(-Inf, 40, 83, 150, Inf), right = TRUE),
         whole_mixed_grains_gram_ea_4 = cut(whole_mixed_grains_gram_ea, breaks = c(-Inf, 120, 210, 350, Inf), right = TRUE),
         eggs_gram_ea_4 = cut(eggs_gram_ea, breaks = c(-Inf, 0, 4.5, 16.5, Inf), right = TRUE),
         eggs_gram_ea_5 = cut(eggs_gram_ea, breaks = c(-Inf, 0, 4, 10, 23, Inf), right = TRUE)
         ) 

levels(ahs_medic_inc2$meat_gram_ea_4)  <- c("None", "<11 g/d", "11-<33 g/d", "33+ g/d")
levels(ahs_medic_inc2$fish_gram_ea_4)  <- c("None", "<9 g/d", "9-<18 g/d", "18+ g/d")
levels(ahs_medic_inc2$eggs_gram_ea_4)  <- c("None", "<4.5 g/d", "4.5-<16.5 g/d", "16.5+ g/d")
levels(ahs_medic_inc2$eggs_gram_ea_5)  <- c("None", "<4 g/d", "4-<10 g/d", "10-<23 g/d", "23+ g/d")
levels(ahs_medic_inc2$alldairy2_gram_ea_4) <- c("None", "<50 g/d", "50-<180 g/d", "180+ g/d")
levels(ahs_medic_inc2$totalveg_gram_ea_4) <- c("<185 g/d", "185-<270 g/d", "270-<380 g/d", "380+ g/d")
levels(ahs_medic_inc2$fruits_gram_ea_4) <- c("<170 g/d", "170-<280 g/d", "280-<420 g/d", "420+ g/d")
levels(ahs_medic_inc2$refgrains_gram_ea_4) <- c("<40 g/d", "40-<83 g/d", "83-<150 g/d", "150+ g/d")
levels(ahs_medic_inc2$whole_mixed_grains_gram_ea_4) <- c("<120 g/d", "120-<210 g/d", "219-<350 g/d", "350+ g/d")
levels(ahs_medic_inc2$nutsseeds_gram_ea_4) <- c("<9 g/d", "9-<18 g/d", "18-<32 g/d", "32+ g/d")
levels(ahs_medic_inc2$legumes_gram_ea_4) <- c("<33 g/d", "33-<60 g/d", "60-<100 g/d", "100+ g/d")

```

## Descriptive table 

* The descriptive table by stroke incidence:

```{r descriptive_table, echo = FALSE}

# Variables to be included
tablevars <- c("agecat", 
               "bene_age_at_end_2020", 
               "bene_sex_F", 
               "rti_race3", 
               "marital", 
               "educyou", 
               "vegstat", 
               "bmicat", 
               "bmi", 
               "exercise", 
               "sleephrs", 
               "smokecat6", 
               "alccat", 
               "como_depress",
               "como_disab", 
               "como_diabetes", 
               "como_hypert", 
               "como_hyperl", 
               "como_resp", 
               "como_anemia", 
               "como_kidney", 
               "como_hypoth", 
               "como_cancers",
               "eggs_gram_ea_5",
               "eggs_gram_ea",
               # "meat_gram_ea_4",
               "meat_gram_ea",
               # "fish_gram_ea_4",
               "fish_gram_ea",
               # "alldairy2_gram_ea_4",
               "alldairy2_gram_ea",
               # "totalveg_gram_ea_4",
               "totalveg_gram_ea",
               # "fruits_gram_ea_4",
               "fruits_gram_ea",
               # "refgrains_gram_ea_4",
               "refgrains_gram_ea",
               # "whole_mixed_grains_gram_ea_4",
               "whole_mixed_grains_gram_ea",
               # "nutsseeds_gram_ea_4",
               "nutsseeds_gram_ea",
               # "legumes_gram_ea_4",
               "legumes_gram_ea"
               )

ahs_medic_inc2 %>%
  mutate(STRK_YN2 = fct_recode(STRK_YN, "Non-case" = "No", "Case" = "Yes")) %>%
  CreateTableOne(tablevars, strata = "STRK_YN2", data = ., addOverall = TRUE) %>% 
  print(showAllLevels = TRUE) %>% 
  kableone()

```

* The descriptive table by egg intake (5 groups):

```{r descriptive_table_by_egg, echo = FALSE}
tablevars2 <- tablevars[tablevars != "eggs_gram_ea_5"]
ahs_medic_inc2 %>% 
  CreateTableOne(c("STRK_YN", tablevars2), strata = "eggs_gram_ea_5", data = ., addOverall = TRUE) %>% 
  print(showAllLevels = TRUE) %>% 
  kableone()

```
## Cox models

* To examine risk factors associated with incident stroke/TIA, we employed the Cox proportional hazards model with attained age as the time scale
  * Age at entry was calculated based on the return date of AHS-2 questionnaire
  * Those who died during the follow-up were censored at the date of death verified in Medicare data
  * Those who were diagnosed with stroke/TIA after the study enrollment were identified as incident cases and their age at diagnosis was calculated. 
    * The mean follow-up years was 16.4 years (median 18.3 years)
    * The total person-years of follow-up was 640,424 years
  * The main exposure variable of interest was energy-adjusted egg intake, gram/day. Subjects were classified into 4 egg intake groups as shown in the descriptive table, and egg intake was entered into the models as categorical
    * This is because there was a non-linear association between egg intake and stoke/TIA when egg intake was entered as continuous (see below)
  * All other dietary variables were entered into the models as continuous. Their hazard ratios were estimated for an increment of 100 gram/day


```{r mv_cox_models_results, echo = FALSE, warning = FALSE, message = FALSE}

# Cox models --------------------------------------------------------------

ahs_medic_inc2 <- ahs_medic_inc2 %>% 
  mutate(bene_sex_F = relevel(bene_sex_F, ref="F"),
         bmicat     = relevel(bmicat, ref="Normal"),
         inc_STRK   = ifelse(STRK_YN == "Yes", 1, 0),
         kcal100    = kcal / 100,
         meat_gram_ea100 = meat_gram_ea / 100,
         fish_gram_ea100 = fish_gram_ea / 100,
         alldairy2_gram_ea100 = alldairy2_gram_ea / 100,
         totalveg_gram_ea100 = totalveg_gram_ea / 100,
         fruits_gram_ea100 = fruits_gram_ea / 100,
         refgrains_gram_ea100 = refgrains_gram_ea / 100,
         whole_mixed_grains_gram_ea100 = whole_mixed_grains_gram_ea / 100,
         nutsseeds_gram_ea100 = nutsseeds_gram_ea / 100,
         legumes_gram_ea100 = legumes_gram_ea / 100)

# Without time-dependent hyperlipidemia -----------------------------------

# Model 1
# Demographics, lifestyles, egg intake (as categorical) and kcal
mv_mod1 <- coxph(Surv(agein, ageout, inc_STRK) ~ eggs_gram_ea_5 + 
                  bene_sex_F + rti_race3 + marital + educyou2 + 
                  bmicat + exercise + sleephrs2 + smokecat6 + alccat +  
                  kcal100, data = ahs_medic_inc2, method = "efron")

# Model 2, adjusting for other foods
# Meat as categorical
# Other food groups as continuous
mv_mod2 <- update(mv_mod1, .~. + meat_gram_ea100 + fish_gram_ea100 + alldairy2_gram_ea100 + totalveg_gram_ea100 +
                                fruits_gram_ea100 + refgrains_gram_ea100 + whole_mixed_grains_gram_ea100 +
                                nutsseeds_gram_ea100 + legumes_gram_ea100)

# Model3 3, adjusting for comorbidity 
mv_mod3 <- update(mv_mod2, .~. + como_depress + como_disab + como_diabetes + como_hyperl  + como_resp + 
                    como_anemia + como_kidney + como_hypoth + como_cancers)

# gtsummary
library(gtsummary)

var_labels <- list(
  eggs_gram_ea_5                = "Egg (energy-adjusted)",
  bene_sex_F                    = "Sex",
  rti_race3                     = "Race (RTI race code)",
  marital                       = "Marital status",
  educyou2                      = "Educational level",
  bmicat                        = "BMI",
  exercise                      = "Exercise",
  sleephrs2                     = "Sleep hours",
  smokecat6                     = "Smoking status",
  alccat                        = "Alcohol use",
  kcal100                       = "Total energy (per 100 kcal)",
  meat_gram_ea100               = "Meat (per 100 g/d)",
  fish_gram_ea100               = "Fish (per 100 g/d)",
  alldairy2_gram_ea100          = "Dairy (per 100 g/d)",
  totalveg_gram_ea100           = "Total vegetables (per 100 g/d)",
  fruits_gram_ea100             = "Fruits (per 100 g/d)",
  refgrains_gram_ea100          = "Refined grains (per 100 g/d)",
  whole_mixed_grains_gram_ea100 = "Whole/mixed grains (per 100 g/d)",
  nutsseeds_gram_ea100          = "Nuts/seeds (per 100 g/d)",
  legumes_gram_ea100            = "Legumes (per 100 g/d)",
  como_depress                  = "Depression",
  como_disab                    = "Functional disability",
  como_diabetes                 = "Diabetes",
  como_hyperl                   = "Hyperlipidemia",
  como_resp                     = "Respiratory diseases",
  como_anemia                   = "Anemia",
  como_kidney                   = "Chronic kidney disease",
  como_hypoth                   = "Hypothyroid",
  como_cancers                  = "Cancers"
)

t1 <- tbl_regression(mv_mod1,
                     label = var_labels,
                     add_estimate_to_reference_rows = TRUE,
                     exponentiate = TRUE,
                     pvalue_fun = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = FALSE)

t2 <- tbl_regression(mv_mod2,
                     label = var_labels,
                     add_estimate_to_reference_rows = TRUE,
                     exponentiate = TRUE,
                     pvalue_fun = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = FALSE)

t3 <- tbl_regression(mv_mod3,
                     label = var_labels,
                     add_estimate_to_reference_rows = TRUE,
                     exponentiate = TRUE,
                     pvalue_fun = label_style_pvalue(digits = 3)) %>% 
  add_global_p(keep = FALSE)

tbl_merge(tbls = list(t1, t2, t3),
          tab_spanner = c("**Model 1**", "**Model 2**", "**Model 3**")) %>% 
  modify_header(label = "**Variable**", 
                p.value_1 = "**p**", 
                p.value_2 = "**p**", 
                p.value_3 = "**p**") %>% 
  as_flex_table()

```

### Restricted cubic spline for egg intake

* In the output above, egg intake was entered into the models as categorical. In the following analysis, we used restricted cubic splines to model a nonlinear association between egg intake as continuous and stroke/TIA.
  * The nonlinear terms of egg intake were highly significant (p = 0.0003)
  * To visualize this nonlinear association, we have plotted hazard ratio for egg intake (adjusting for all other covariates) with 95 confidence intervals
  * The reference for egg intake was set to 0 gram/day to make comparisons easier with the table above

```{r cubic_spline_egg, echo = FALSE, warning = FALSE, message = FALSE}

library(rms)

# Restricted cubic spline
dd <- datadist(ahs_medic_inc2)
options(datadist='dd')

# Remove RCS terms for all other food groups
mv_mod3_rcs2 <- cph(Surv(agein, ageout, inc_STRK) ~ bene_sex_F + rti_race3 + marital + educyou2 + 
                       bmicat + exercise + sleephrs2 + smokecat6 + alccat + kcal100 +
                       rcs(eggs_gram_ea, parms = 4) + 
                       rcs(nutsseeds_gram_ea, parms = 4) + 
                       meat_gram_ea + 
                       fish_gram_ea + 
                       alldairy2_gram_ea + 
                       totalveg_gram_ea + 
                       fruits_gram_ea + 
                       refgrains_gram_ea + 
                       whole_mixed_grains_gram_ea + 
                       legumes_gram_ea, 
                       data = ahs_medic_inc2, method = "efron", x = TRUE, y = TRUE)

# Change the reference to 0 g/d
dd$limits$eggs_gram_ea[2] <- 0
mv_mod3_rcs3 <- update(mv_mod3_rcs2)

Predict(mv_mod3_rcs3, eggs_gram_ea = seq(0, 50, by = 1), fun = exp, ref.zero = TRUE) %>% 
  ggplot() +
  geom_line(linewidth = 1.3) +
  scale_y_continuous(breaks = 5:14 / 10) +
  geom_hline(yintercept =  1, linetype = 2) +
  coord_cartesian(ylim = c(0.7, 1.1)) +
  labs(x = "Egg intake (energy-adjusted, gram/day)",
       y = "Adjusted hazard ratio (95% CI)",
       caption = "",
       title = "Model 3: Cubic spline for egg intake (Ref = 0 g/d)") +
  theme(text=element_text(size = 14))

```

* Hazard ratios at selected points of egg intake and their 95 CI are shown below:

```{r cubic_spline_egg_tab, echo = FALSE, warning = FALSE, message = FALSE}
Predict(mv_mod3_rcs3, eggs_gram_ea = c(5, 10, 15, 20, 30, 50), fun = exp, ref.zero = TRUE) %>% 
  mutate(`Egg intake (g/d)` = eggs_gram_ea,
         `HR` = round(yhat, 2),
         `Lower` = round(lower, 2),
         `Upper` = round(upper, 2)) %>% 
  select(`Egg intake (g/d)`, `HR`, `Lower`, `Upper`) %>%
  knitr::kable()
```

### Interaction between egg and meat intake

* There were no significant interactions between egg and meat intake (p = 0.34)

### Interaction between egg and race 

* There were no significant interactions between egg and RTI race (p = 0.42)

### Hyperlipidemia as time-dependent

* To examine if the effect of egg intake may be dependent on hyperlipidemia, we have used hyperlipidemia as a time-dependent variable in the Cox model (after removing prevalent hyperlipidemia status from the model)
  * There were no significant interactions between egg intake and time-dependent hyperlipidemia status (p = 0.75, Model 3)

